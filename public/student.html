<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Encuesta SCAS (12–15)</title>
  <link rel="stylesheet" href="styles.css"/>

  <style>
    /* Paleta y base */
    :root{
      --bg:#faf7f2;
      --card:#fff;
      --text:#1f2937;
      --muted:#6b7280;
      --brand:#f59e0b;
      --brand-2:#fde68a;
      --accent:#8b5cf6;
      --border:#eadfd2;
      --choice:#fce7c6;
      --choice-border:#f4c27a;
      --choice-hover:#fde9cc;
    }
    html,body{ background:var(--bg); }

    .wrap{ max-width:980px; margin:28px auto 40px; padding:0 16px; }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:0 10px 34px rgba(0,0,0,.06);
      padding:22px;
    }

    .head{
      margin-bottom:12px;
    }
    .title{
      margin:0 0 4px;
      font-weight:900; letter-spacing:0.2px;
      font-size:clamp(20px,3vw,28px); color:var(--text);
    }
    .hello{
      margin:0; color:var(--muted); font-weight:700;
    }

    /* Paso / numeración */
    .step{
      display:inline-flex; align-items:center; gap:8px;
      color:#b45309; font-weight:900; margin: 12px 0 4px;
    }

    /* Texto principal de la pregunta */
    .question{
      margin:6px 0 12px;
      font-weight:900; font-size:clamp(20px,2.6vw,28px); color:var(--text);
    }

    .sub{
      margin: 2px 0 16px;
      color:var(--muted); font-weight:700;
    }

    /* Opciones */
    .choices{ display:flex; flex-direction:column; gap:12px; margin: 8px 0 18px; }
    .choice{
      display:flex; align-items:center; gap:14px;
      border:2px solid var(--choice-border);
      border-radius:12px; padding:14px 16px;
      background:var(--choice); cursor:pointer;
      transition: transform .06s ease, background .12s ease;
      user-select:none;
    }
    .choice:hover{ background:var(--choice-hover); transform:translateY(-1px); }
    .choice .tag{
      min-width:28px; height:28px; border-radius:8px;
      border:2px solid var(--choice-border);
      display:grid; place-items:center;
      font-weight:900; color:#9a6700; background:var(--brand-2);
      font-size:13px;
    }
    .choice .label{ font-weight:800; color:#111; }
    .choice .dot{
      margin-left:auto;
      width:16px; height:16px; border-radius:6px;
      border:2px solid var(--choice-border); background:#fff;
    }
    .choice.active{ outline:3px solid #c084fc; }
    .choice.active .dot{ background:#8b5cf6; border-color:#8b5cf6; }

    /* Footer con controles y progreso */
    .footer{
      display:flex; align-items:center; gap:12px; margin-top:8px;
      flex-wrap:wrap;
    }
    .btn{
      border:none; padding:12px 18px; border-radius:12px;
      font-weight:800; cursor:pointer;
    }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
    .btn-muted{ background:#f1f5f9; color:#111827; }
    .btn-next{ background:var(--accent); color:#fff; }
    .btn-next.alt{ background:#10b981; } /* Ver resultados */

    .px{
      display:flex; align-items:center; gap:8px; color:#6b7280;
      font-weight:800; margin-left:auto;
    }
    .bar{
      width:100%; height:8px; border-radius:999px; background:#efe5d9;
      margin-top:10px; overflow:hidden;
    }
    .bar > span{
      display:block; height:100%; width:0%; background:#d8c7ac;
      transition: width .15s ease-in-out;
      border-radius:999px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <section class="card">
      <!-- Cabecera (dentro de la MISMA tarjeta) -->
      <div class="head">
        <h1 class="title">Encuesta SCAS (12–15)</h1>
        <p id="hello" class="hello"></p>
      </div>

      <!-- Cuerpo: pregunta única por pantalla -->
      <div id="quiz">
        <div id="step" class="step">1 →</div>
        <h2 id="qtext" class="question">Cargando…</h2>
        <p class="sub">Selecciona una opción</p>

        <div id="choices" class="choices"></div>

        <div class="footer">
          <button id="btnPrev" class="btn btn-muted" disabled>Atrás</button>
          <button id="btnNext" class="btn btn-next" disabled>Siguiente</button>

          <div class="px">
            <span id="progText">Progreso: 0 / 44 respondidas</span>
          </div>

          <div class="bar"><span id="progBar"></span></div>
        </div>
      </div>
    </section>
  </div>

  <script src="app.js"></script>
  <script>
    // --- Requiere sesión
    ensureAuthOrRedirect('student');

    // Estado
    const state = {
      items: [],
      index: 0,
      answers: new Map(),          // item_id -> value 0..3
      usedBack: false,             // si usó "Atrás" alguna vez
      completedOnce: false         // si ya contestó todas
    };

    const DOM = {
      hello:    document.getElementById('hello'),
      step:     document.getElementById('step'),
      qtext:    document.getElementById('qtext'),
      choices:  document.getElementById('choices'),
      btnPrev:  document.getElementById('btnPrev'),
      btnNext:  document.getElementById('btnNext'),
      progText: document.getElementById('progText'),
      progBar:  document.getElementById('progBar'),
    };

    // Bienvenida
    const nombre = localStorage.getItem('fullname') || 'estudiante';
    DOM.hello.textContent =
      `Hola, ${nombre}. Te damos la bienvenida. ` +
      `Responde según cómo te has sentido últimamente. ` +
      `Selecciona una opción en cada pregunta.`;

    // Cargar encuesta
    init();

    async function init(){
      try {
        const res = await fetch('/api/survey/scas', {
          headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
        });
        const data = await res.json();
        if(!res.ok) throw new Error(data.error || 'Error al cargar encuesta');

        state.items = data.items || [];
        render();
      } catch (e) {
        DOM.qtext.textContent = 'No se pudo cargar la encuesta.';
        console.error(e);
      }
    }

    // RENDER
    function render(){
      const total = state.items.length;
      if(!total) return;

      // Índices de seguridad
      state.index = Math.max(0, Math.min(state.index, total-1));

      const item = state.items[state.index];
      DOM.step.textContent = `${state.index + 1} →`;
      DOM.qtext.textContent = item.prompt || `Pregunta ${state.index + 1}`;

      // Pintar opciones
      DOM.choices.innerHTML = '';
      const chosen = state.answers.has(item.id) ? state.answers.get(item.id) : null;

      const OPTIONS = [
        {tag:'A', label:'Nunca',   val:0},
        {tag:'B', label:'A veces', val:1},
        {tag:'C', label:'A menudo',val:2},
        {tag:'D', label:'Siempre', val:3},
      ];
      for(const opt of OPTIONS){
        const row = document.createElement('div');
        row.className = 'choice' + (chosen===opt.val ? ' active' : '');
        row.innerHTML = `
          <span class="tag">${opt.tag}</span>
          <span class="label">${opt.label}</span>
          <span class="dot"></span>
        `;
        row.addEventListener('click', ()=> onChoose(item.id, opt.val));
        DOM.choices.appendChild(row);
      }

      // controles
      DOM.btnPrev.disabled = state.index === 0;
      // next habilitado solo si la actual tiene respuesta
      DOM.btnNext.disabled = !state.answers.has(item.id);

      // Texto/acción de Next
      updateNextButton();

      updateProgress();
    }

    function updateNextButton(){
      // Si ya se respondieron todas:
      const finished = state.answers.size === state.items.length;
      state.completedOnce = state.completedOnce || finished;

      if(finished && !state.usedBack){
        DOM.btnNext.textContent = 'Ver resultados';
        DOM.btnNext.classList.add('alt');
      } else {
        DOM.btnNext.textContent = 'Siguiente';
        DOM.btnNext.classList.remove('alt');
      }
    }

    function updateProgress(){
      const answered = state.answers.size;
      const total = state.items.length;
      DOM.progText.textContent = `Progreso: ${answered} / ${total} respondidas`;

      const pct = Math.round((answered / total) * 100) || 0;
      DOM.progBar.style.width = pct + '%';
    }

    // AL ELEGIR OPCIÓN → guarda y auto-avanza
    function onChoose(itemId, value){
      const before = state.answers.has(itemId);
      state.answers.set(itemId, value);

      // habilitar next en la actual
      DOM.btnNext.disabled = false;

      // Auto-avanzo (si no es la última)
      if(state.index < state.items.length - 1){
        state.index++;
        render();
      } else {
        // última: actualizar botón a "Ver resultados" si no usó back
        updateNextButton();
      }
    }

    // NAV
    DOM.btnPrev.addEventListener('click', ()=>{
      state.usedBack = true;
      if(state.index > 0){
        state.index--;
        render();
      }
    });

    DOM.btnNext.addEventListener('click', ()=>{
      const atLast = state.index === state.items.length - 1;
      const allDone = state.answers.size === state.items.length;

      if(allDone && !state.usedBack){
        // Directo a resultados
        submitAndGo();
      } else if(atLast && allDone){
        // Si usó "Atrás", avanza paso-a-paso y aquí sí va a resultados
        submitAndGo();
      } else {
        // Avanza 1
        if(state.index < state.items.length - 1){
          state.index++;
          render();
        }
      }
    });

    async function submitAndGo(){
      try {
        const payload = {
          answers: Array.from(state.answers.entries()).map(([item_id, value])=>({item_id, value}))
        };
        const res = await fetch('/api/survey/scas/submit', {
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'Authorization':'Bearer ' + localStorage.getItem('token')
          },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if(!res.ok) throw new Error(data.error || 'No se pudo enviar');

        // Guardamos y vamos a resultados
        sessionStorage.setItem('scasResult', JSON.stringify(data));
        location.href = '/results.html';
      } catch (e) {
        alert('No se pudo enviar la encuesta. Intenta otra vez.');
        console.error(e);
      }
    }
  </script>
</body>
</html>
